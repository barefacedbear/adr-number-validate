name: Package publish to npm on main

on:
  push:
   branches: [main]

jobs:
  publish:
    name: Publish (only on version change)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  
    env:
      LIB_NAME: "@dravishek/number-validate"
      LIB_SOURCE_DIR: projects/dravishek/number-validate
      DIST_DIR: dist/dravishek/number-validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
      
      - name: Install deps
        run: npm ci

      - name: Run tests
        run: npm test --if-present

      - name: Build
        run: npx ng build "${{env.LIB_NAME}}" --configuration production

      - name: Enable npm provenance
        run: npm config set provenance true

      - name: Configure npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Read package name & version (from source)
        id: pkgmeta
        run: |
          PKG_NAME=$(node -p "require('./${{ env.LIB_SOURCE_DIR }}/package.json').name")
          PKG_VERSION=$(node -p "require('./${{ env.LIB_SOURCE_DIR }}/package.json').version")
          echo "name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "version=$PKG_VERSION" >> $GITHUB_OUTPUT

      - name: Detect version file change
        id: version_changed
        run: |
          FILE="${{ env.LIB_SOURCE_DIR }}/package.json"
          # Find previous commit that touched the file; if none, treat as changed
          PREV=$(git rev-list -n 1 HEAD^ -- "$FILE" || echo "")
          if [ -z "$PREV" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            if git diff --quiet "$PREV" HEAD -- "$FILE"; then
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Check if version already exists on npm
        id: exists_on_npm
        run: |
          if npm view "${{ steps.pkgmeta.outputs.name }}@${{ steps.pkgmeta.outputs.version }}" version > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Show built contents (debug)
        run: ls -la "${{ env.DIST_DIR }}"

      - name: Publish to npm (from dist)
        if: steps.version_changed.outputs.changed == 'true' && steps.exists_on_npm.outputs.exists == 'false'
        working-directory: ${{ env.DIST_DIR }}
        run: npm publish --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Skip reason
        if: steps.version_changed.outputs.changed != 'true' || steps.exists_on_npm.outputs.exists == 'true'
        run: |
          echo "Skipping publish."
          echo "Version file changed? ${{ steps.version_changed.outputs.changed }}"
          echo "Already on npm? ${{ steps.exists_on_npm.outputs.exists }}"
          echo "Package: ${{ steps.pkgmeta.outputs.name }}"
          echo "Version: ${{ steps.pkgmeta.outputs.version }}"
